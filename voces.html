<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Teleprompter Auditivo</title>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#ec4899",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                    },
                    fontFamily: {
                        display: ["Sora", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "0.75rem",
                    },
                },
            },
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 4px;
            background: #e2e8f0;
            border-radius: 9999px;
        }
        .dark input[type="range"]::-webkit-slider-runnable-track {
            background: #475569;
        }
        input[type="range"]::-moz-range-track {
            height: 4px;
            background: #e2e8f0;
            border-radius: 9999px;
        }
        .dark input[type="range"]::-moz-range-track {
            background: #475569;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background-color: #ec4899;
            border-radius: 9999px;
            border: 2px solid #f8fafc;
            cursor: pointer;
            margin-top: -6px;
        }
        .dark input[type="range"]::-webkit-slider-thumb {
            border-color: #0f172a;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background-color: #ec4899;
            border-radius: 9999px;
            border: 2px solid #f8fafc;
            cursor: pointer;
        }
        .dark input[type="range"]::-moz-range-thumb {
            border-color: #0f172a;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        .status-dot { width: 10px; height: 10px; border-radius: 9999px; background: #334155; }
        .status-dot.speaking { background: #4ade80; animation: pulse 1s infinite; }
        .status-dot.waiting { background: #fbbf24; }
        .status-dot.paused { background: #ec4899; }
        .status-dot.loading { background: #60a5fa; animation: pulse 0.5s infinite; }
        .status-dot.finished { background: #ec4899; }
        .status-dot.generating { background: #8b5cf6; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .video-dot { width: 12px; height: 12px; border-radius: 9999px; background: #334155; }
        .video-dot.done { background: #22c55e; }
        .video-dot.current { background: #ec4899; animation: pulse 1s infinite; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-slate-700 dark:text-slate-300 antialiased">
    <div class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        
        <!-- SETUP SCREEN -->
        <div id="setup" class="screen active w-full max-w-7xl">
            <header class="w-full mb-8">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl text-slate-500 dark:text-slate-400">headphones</span>
                    <h1 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Teleprompter Auditivo</h1>
                </div>
            </header>

            <div id="error" class="hidden w-full mb-4 bg-red-900/50 border border-red-500 rounded-lg p-4 text-sm text-red-200"></div>

            <main class="w-full flex flex-col lg:flex-row gap-6">
                <!-- Left Column: Script -->
                <div class="flex-grow lg:w-3/5">
                    <div class="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-sm h-full flex flex-col">
                        <label class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-4" for="script">Pega tu guion en bruto aqu√≠...</label>
                        <textarea id="script" class="w-full flex-grow min-h-[300px] bg-slate-100 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary text-slate-700 dark:text-slate-300 p-4 resize-none" placeholder="Luego pulsa 'Procesar con IA' para optimizarlo autom√°ticamente."></textarea>
                        <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 flex items-start gap-2">
                            <span class="material-symbols-outlined text-sm text-yellow-500">lightbulb</span>
                            <span>Pega el guion tal cual. La IA lo optimizar√°: mejora redacci√≥n, corta frases, decide repeticiones.</span>
                        </p>
                    </div>
                </div>

                <!-- Right Column: Settings -->
                <div class="lg:w-2/5 flex flex-col gap-6">
                    <!-- Datos del v√≠deo -->
                    <div class="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-sm">
                        <h2 class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-4">DATOS DEL V√çDEO</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input id="inmobiliaria" type="text" class="w-full bg-slate-100 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary placeholder-slate-400 dark:placeholder-slate-500 px-4 py-2" placeholder="Nombre inmobiliaria">
                            <input id="ciudad" type="text" class="w-full bg-slate-100 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary placeholder-slate-400 dark:placeholder-slate-500 px-4 py-2" placeholder="Ciudad">
                        </div>
                    </div>

                    <!-- Bot√≥n Procesar IA -->
                    <button id="btnIA" disabled class="w-full bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:text-slate-600 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-yellow-400 text-lg">auto_awesome</span>
                        Procesar con IA
                    </button>

                    <!-- Voz -->
                    <div class="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-sm">
                        <p class="text-sm text-slate-500 dark:text-slate-400">Voz: <span id="voiceName" class="font-semibold text-primary">Cargando...</span></p>
                        <div class="relative mt-4">
                            <select id="voiceSelect" class="w-full appearance-none bg-slate-100 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary text-slate-800 dark:text-slate-200 px-4 py-2.5" style="display:none"></select>
                            <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">expand_more</span>
                        </div>
                        <button id="btnPreview" disabled class="mt-4 w-full bg-slate-100 hover:bg-slate-200 dark:bg-slate-900 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-slate-600 dark:text-slate-300 font-semibold py-2.5 px-4 rounded border border-slate-200 dark:border-slate-700 flex items-center justify-center gap-2 transition-colors">
                            <span class="material-symbols-outlined text-primary">graphic_eq</span>
                            Escuchar voz
                        </button>
                    </div>

                    <!-- Configuraci√≥n -->
                    <div class="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-sm">
                        <h2 class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-6">CONFIGURACI√ìN</h2>
                        <div class="space-y-6">
                            <div class="flex items-center justify-between gap-4">
                                <label class="text-sm w-24">Velocidad</label>
                                <input id="speed" type="range" min="0.5" max="1.5" step="0.1" value="0.8" class="w-full h-1 rounded-lg appearance-none cursor-pointer">
                                <span id="speedVal" class="text-sm font-semibold w-8 text-right text-primary">0.8x</span>
                            </div>
                            <div class="flex items-center justify-between gap-4">
                                <label class="text-sm w-24">Estabilidad</label>
                                <input id="stability" type="range" min="0" max="1" step="0.1" value="0.6" class="w-full h-1 rounded-lg appearance-none cursor-pointer">
                                <span id="stabilityVal" class="text-sm font-semibold w-8 text-right text-primary">0.6</span>
                            </div>
                            <div class="flex items-center justify-between gap-4">
                                <label class="text-sm w-24">Expresividad</label>
                                <input id="similarity" type="range" min="0" max="1" step="0.1" value="0.5" class="w-full h-1 rounded-lg appearance-none cursor-pointer">
                                <span id="similarityVal" class="text-sm font-semibold w-8 text-right text-primary">0.5</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pausas -->
                    <div class="bg-white dark:bg-slate-800/50 p-6 rounded-lg shadow-sm">
                        <h2 class="text-sm font-semibold uppercase text-slate-500 dark:text-slate-400 mb-6">PAUSAS ENTRE FRASES</h2>
                        <div class="flex items-center justify-between gap-4">
                            <label class="text-sm w-24">Multiplicador</label>
                            <input id="mult" type="range" min="0.5" max="3" step="0.25" value="1.5" class="w-full h-1 rounded-lg appearance-none cursor-pointer">
                            <span id="multVal" class="text-sm font-semibold w-8 text-right text-primary">1.5x</span>
                        </div>
                    </div>

                    <!-- Bot√≥n Empezar -->
                    <button id="btnStart" disabled class="w-full bg-primary hover:bg-pink-600 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                        <span class="material-symbols-outlined text-lg">play_arrow</span>
                        Preparar y empezar
                    </button>
                </div>
            </main>
        </div>

        <!-- PLAYER SCREEN -->
        <div id="player" class="screen w-full max-w-2xl">
            <header class="w-full mb-8">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl text-slate-500 dark:text-slate-400">headphones</span>
                    <h1 class="text-2xl font-semibold text-slate-800 dark:text-slate-100">Teleprompter Auditivo</h1>
                </div>
            </header>

            <!-- Video Progress Dots -->
            <div id="videoProgress" class="flex justify-center gap-2 mb-6"></div>

            <!-- Phrase Box -->
            <div class="bg-white dark:bg-slate-800/50 rounded-xl p-8 mb-6 shadow-sm">
                <div id="videoCounter" class="text-xs font-semibold text-primary text-center mb-2">V√≠deo 1 de 1</div>
                <div id="counter" class="text-sm text-slate-500 dark:text-slate-400 text-center mb-4">1 / 1</div>
                <div id="phraseText" class="text-xl leading-relaxed text-center text-slate-800 dark:text-slate-100 min-h-[80px] flex items-center justify-center"></div>
                <div id="repInd" class="text-xs text-primary text-center mt-4"></div>
            </div>

            <!-- Status Bar -->
            <div class="flex justify-center items-center gap-2 mb-4 text-sm text-slate-500 dark:text-slate-400">
                <div id="statusDot" class="status-dot"></div>
                <span id="statusText">Listo</span>
            </div>

            <!-- Progress Bar -->
            <div class="h-1 bg-slate-200 dark:bg-slate-700 rounded-full mb-8 overflow-hidden">
                <div id="progressFill" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Controls Normal -->
            <div id="controlsNormal" class="grid grid-cols-3 gap-3 mb-4">
                <button id="btnPrev" class="bg-white dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg p-4 flex flex-col items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-2xl text-slate-600 dark:text-slate-300">skip_previous</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">Anterior</span>
                </button>
                <button id="btnRepeat" class="bg-white dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg p-4 flex flex-col items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-2xl text-slate-600 dark:text-slate-300">replay</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">Repetir</span>
                </button>
                <button id="btnNext" class="bg-white dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg p-4 flex flex-col items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-2xl text-slate-600 dark:text-slate-300">skip_next</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400">Siguiente</span>
                </button>
                <button id="btnPlayPause" class="col-span-3 bg-primary hover:bg-pink-600 text-white rounded-lg p-5 flex items-center justify-center gap-3 transition-colors">
                    <span class="icon material-symbols-outlined text-3xl">pause</span>
                    <span id="ppText" class="font-semibold">Pausar</span>
                </button>
            </div>

            <!-- Controls Next Video -->
            <div id="controlsNextVideo" class="hidden mb-4">
                <button id="btnNextVideo" class="w-full bg-green-500 hover:bg-green-600 text-white rounded-lg p-6 flex items-center justify-center gap-3 transition-colors">
                    <span class="icon material-symbols-outlined text-3xl">play_arrow</span>
                    <span class="font-semibold text-lg">Siguiente v√≠deo</span>
                </button>
            </div>

            <!-- Back Button -->
            <button id="btnBack" class="w-full bg-transparent hover:bg-slate-800/50 border border-slate-300 dark:border-slate-700 text-slate-500 dark:text-slate-400 rounded-lg py-3 flex items-center justify-center gap-2 transition-colors">
                <span class="material-symbols-outlined">arrow_back</span>
                Volver
            </button>
        </div>

        <!-- LOADING OVERLAY -->
        <div id="loadingOverlay" class="fixed inset-0 bg-background-dark/95 flex flex-col items-center justify-center z-50" style="display:none">
            <h2 id="loadingTitle" class="text-xl font-semibold text-slate-100 mb-4">Procesando...</h2>
            <p id="loadingText" class="text-slate-400 mb-6">Preparando guion...</p>
            <div class="w-48 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                <div id="loadingBar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

<script>
const API_ELEVENLABS = 'https://elevenlabs-proxy.ajnietoc.workers.dev';
const API_CLAUDE = 'https://claude-guiones.ajnietoc.workers.dev';

let voices=[],videos=[],phrases=[],phraseReps=[],idx=0,rep=0,videoIdx=0,playing=false,paused=false,audio=null,timeout=null,lastDur=0,cache={};
let cfg={speed:0.8,stability:0.6,similarity:0.5,mult:1.5,voiceId:null,voiceName:''};
let guionProcesado=false;

const $=id=>document.getElementById(id);
const showErr=m=>{$('error').textContent=m;$('error').classList.remove('hidden');};
const hideErr=()=>$('error').classList.add('hidden');

function playBeep(){
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);
    o.frequency.value=880;
    o.type='sine';
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5);
    o.start(ctx.currentTime);
    o.stop(ctx.currentTime+0.5);
}

function showLoading(title,text,progress){
    $('loadingOverlay').style.display='flex';
    $('loadingTitle').textContent=title;
    $('loadingText').textContent=text;
    $('loadingBar').style.width=progress+'%';
}
function hideLoading(){$('loadingOverlay').style.display='none';}

async function loadVoices(){
    try{
        const r=await fetch(API_ELEVENLABS+'/voices');
        if(!r.ok)throw new Error();
        const d=await r.json();
        voices=d.voices;
        let stela=voices.find(v=>v.name.toLowerCase().includes('stela'));
        if(stela){selectVoice(stela.voice_id,stela.name);}
        else if(voices.length>0){selectVoice(voices[0].voice_id,voices[0].name);}
        $('voiceSelect').innerHTML=voices.map(v=>'<option value="'+v.voice_id+'"'+(v.voice_id===cfg.voiceId?' selected':'')+'>'+v.name+'</option>').join('');
        $('voiceSelect').style.display='block';
        $('btnPreview').disabled=false;
    }catch(e){$('voiceName').textContent='Error';showErr('No se pudieron cargar las voces');}
}

function selectVoice(id,name){cfg.voiceId=id;cfg.voiceName=name;$('voiceName').textContent=name;checkButtons();}

function checkButtons(){
    $('btnIA').disabled=!$('script').value.trim();
    $('btnStart').disabled=!($('script').value.trim()&&cfg.voiceId&&guionProcesado);
}

async function procesarConIA(){
    var guion=$('script').value.trim();
    if(!guion)return;
    
    showLoading('‚ú® Procesando con IA','La IA est√° optimizando tu guion...',30);
    $('btnIA').disabled=true;
    
    try{
        const r=await fetch(API_CLAUDE,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                guion:guion,
                inmobiliaria:$('inmobiliaria').value.trim(),
                ciudad:$('ciudad').value.trim()
            })
        });
        
        if(!r.ok)throw new Error('Error en la API');
        const d=await r.json();
        if(d.error)throw new Error(d.error);
        
        $('script').value=d.guion;
        guionProcesado=true;
        hideLoading();
        checkButtons();
    }catch(e){
        hideLoading();
        showErr('Error procesando: '+e.message);
        $('btnIA').disabled=false;
    }
}

function parseGuionProcesado(text){
    var lines=text.split('\n').map(function(l){return l.trim();}).filter(function(l){return l;});
    var vids=[];
    var currentVideo=[];
    var currentReps=[];
    
    for(var i=0;i<lines.length;i++){
        var line=lines[i];
        
        if(line==='---'||line==='***'){
            if(currentVideo.length>0){
                vids.push({phrases:currentVideo,reps:currentReps});
                currentVideo=[];
                currentReps=[];
            }
            continue;
        }
        
        var match=line.match(/^\[(\d)x\]\s*(.+)$/);
        if(match){
            currentReps.push(parseInt(match[1]));
            currentVideo.push(match[2]);
        }else if(line){
            currentReps.push(1);
            currentVideo.push(line);
        }
    }
    
    if(currentVideo.length>0){
        vids.push({phrases:currentVideo,reps:currentReps});
    }
    
    return vids;
}

async function genSpeech(text){
    const key=cfg.voiceId+'-'+text+'-'+cfg.speed+'-'+cfg.stability+'-'+cfg.similarity;
    if(cache[key])return cache[key];
    const r=await fetch(API_ELEVENLABS+'/text-to-speech/'+cfg.voiceId,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text:text,model_id:'eleven_multilingual_v2',voice_settings:{stability:cfg.stability,similarity_boost:cfg.similarity,speed:cfg.speed}})
    });
    if(!r.ok)throw new Error('Error generando audio');
    const blob=await r.blob();
    cache[key]=URL.createObjectURL(blob);
    return cache[key];
}

async function preGenerarTodo(){
    var allPhrases=[];
    for(var v=0;v<videos.length;v++){
        for(var p=0;p<videos[v].phrases.length;p++){
            allPhrases.push(videos[v].phrases[p]);
        }
    }
    
    for(var i=0;i<allPhrases.length;i++){
        showLoading('üîä Generando audio','Frase '+(i+1)+' de '+allPhrases.length,Math.round((i+1)/allPhrases.length*100));
        await genSpeech(allPhrases[i]);
    }
}

function stopAudio(){if(audio){audio.pause();audio=null;}if(timeout){clearTimeout(timeout);timeout=null;}}

function setStatus(s){
    $('statusDot').className='status-dot '+s;
    $('statusText').textContent=s==='speaking'?'Dictando...':s==='waiting'?'Tu turno':s==='paused'?'Pausa':s==='loading'?'Cargando...':s==='finished'?'¬°V√≠deo terminado!':'Listo';
}

function updateUI(){
    $('videoCounter').textContent='V√≠deo '+(videoIdx+1)+' de '+videos.length;
    $('counter').textContent=(idx+1)+' / '+phrases.length;
    $('phraseText').textContent=phrases[idx]||'';
    $('progressFill').style.width=((idx+1)/phrases.length*100)+'%';
    var maxRep=phraseReps[idx]||1;
    $('repInd').textContent=maxRep>1?'Rep '+(rep+1)+'/'+maxRep:'';
    var dots='';
    for(var i=0;i<videos.length;i++){
        if(i<videoIdx)dots+='<div class="video-dot done"></div>';
        else if(i===videoIdx)dots+='<div class="video-dot current"></div>';
        else dots+='<div class="video-dot"></div>';
    }
    $('videoProgress').innerHTML=dots;
}

function showNextVideoButton(){
    $('controlsNormal').style.display='none';
    $('controlsNextVideo').style.display='block';
    setStatus('finished');
    playBeep();
}

function hideNextVideoButton(){
    $('controlsNormal').style.display='grid';
    $('controlsNextVideo').style.display='none';
}

async function playPhrase(){
    if(!playing||paused||idx>=phrases.length)return;
    updateUI();setStatus('speaking');
    try{
        const url=await genSpeech(phrases[idx]);
        audio=new Audio(url);
        const start=Date.now();
        audio.onended=function(){
            lastDur=(Date.now()-start)/1000;
            rep++;
            var maxRep=phraseReps[idx]||1;
            if(rep<maxRep){
                updateUI();
                timeout=setTimeout(playPhrase,400);
                return;
            }
            rep=0;
            if(idx<phrases.length-1){
                setStatus('waiting');
                timeout=setTimeout(function(){idx++;playPhrase();},lastDur*cfg.mult*1000);
            }else{
                playing=false;
                if(videoIdx<videos.length-1){
                    showNextVideoButton();
                }else{
                    setStatus('');
                    $('ppText').textContent='Reiniciar';
                    $('btnPlayPause').querySelector('.icon').textContent='play_arrow';
                    playBeep();
                }
            }
        };
        audio.play();
    }catch(e){showErr(e.message);playing=false;}
}

function startVideo(vIdx){
    videoIdx=vIdx;
    phrases=videos[videoIdx].phrases;
    phraseReps=videos[videoIdx].reps;
    idx=0;rep=0;
    hideNextVideoButton();
    updateUI();
    playing=true;paused=false;
    $('ppText').textContent='Pausar';
    $('btnPlayPause').querySelector('.icon').textContent='pause';
    playPhrase();
}

$('script').addEventListener('input',function(){guionProcesado=false;checkButtons();});
$('voiceSelect').addEventListener('change',function(e){var v=voices.find(x=>x.voice_id===e.target.value);if(v)selectVoice(v.voice_id,v.name);});
$('speed').addEventListener('input',function(e){cfg.speed=parseFloat(e.target.value);$('speedVal').textContent=cfg.speed+'x';});
$('stability').addEventListener('input',function(e){cfg.stability=parseFloat(e.target.value);$('stabilityVal').textContent=cfg.stability;});
$('similarity').addEventListener('input',function(e){cfg.similarity=parseFloat(e.target.value);$('similarityVal').textContent=cfg.similarity;});
$('mult').addEventListener('input',function(e){cfg.mult=parseFloat(e.target.value);$('multVal').textContent=cfg.mult+'x';});

$('btnIA').addEventListener('click',procesarConIA);

$('btnPreview').addEventListener('click',async function(){
    $('btnPreview').disabled=true;$('btnPreview').innerHTML='<span class="material-symbols-outlined text-primary animate-spin">progress_activity</span> Generando...';
    try{var url=await genSpeech('Hola, esta es una prueba de voz.');var a=new Audio(url);a.onended=function(){$('btnPreview').disabled=false;$('btnPreview').innerHTML='<span class="material-symbols-outlined text-primary">graphic_eq</span> Escuchar voz';};a.play();}
    catch(e){showErr(e.message);$('btnPreview').disabled=false;$('btnPreview').innerHTML='<span class="material-symbols-outlined text-primary">graphic_eq</span> Escuchar voz';}
});

$('btnStart').addEventListener('click',async function(){
    videos=parseGuionProcesado($('script').value);
    if(!videos.length||!videos[0].phrases.length){showErr('No hay guiones');return;}
    cache={};hideErr();
    
    try{
        await preGenerarTodo();
        hideLoading();
        $('setup').classList.remove('active');
        $('player').classList.add('active');
        startVideo(0);
    }catch(e){
        hideLoading();
        showErr('Error generando audio: '+e.message);
    }
});

$('btnNextVideo').addEventListener('click',function(){
    if(videoIdx<videos.length-1){startVideo(videoIdx+1);}
});

$('btnPlayPause').addEventListener('click',function(){
    if(!playing){startVideo(videoIdx);}
    else if(paused){paused=false;$('ppText').textContent='Pausar';$('btnPlayPause').querySelector('.icon').textContent='pause';playPhrase();}
    else{paused=true;stopAudio();setStatus('paused');$('ppText').textContent='Continuar';$('btnPlayPause').querySelector('.icon').textContent='play_arrow';}
});

$('btnPrev').addEventListener('click',function(){stopAudio();idx=Math.max(0,idx-1);rep=0;updateUI();if(playing&&!paused)playPhrase();});
$('btnNext').addEventListener('click',function(){stopAudio();idx=Math.min(phrases.length-1,idx+1);rep=0;updateUI();if(playing&&!paused)playPhrase();});
$('btnRepeat').addEventListener('click',function(){stopAudio();rep=0;if(playing&&!paused)playPhrase();});
$('btnBack').addEventListener('click',function(){stopAudio();playing=false;paused=false;$('player').classList.remove('active');$('setup').classList.add('active');hideNextVideoButton();});

loadVoices();
</script>
</body>
</html>
