<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Teleprompter Auditivo</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #fff; min-height: 100vh; padding: 16px; }
        .container { max-width: 500px; margin: 0 auto; }
        h1 { text-align: center; font-size: 1.3rem; margin-bottom: 20px; color: #94a3b8; font-weight: 500; }
        .screen { display: none; }
        .screen.active { display: block; }
        textarea { width: 100%; height: 180px; padding: 16px; border: 1px solid #334155; border-radius: 12px; background: #1e293b; color: #fff; font-size: 16px; resize: none; margin-bottom: 12px; }
        textarea:focus { outline: none; border-color: #ec4899; }
        textarea::placeholder { color: #64748b; }
        .hint { font-size: 0.75rem; color: #64748b; margin-bottom: 16px; line-height: 1.4; }
        .section { background: #1e293b; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .section-title { font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .row:last-child { margin-bottom: 0; }
        .row label { font-size: 0.85rem; color: #94a3b8; }
        .row input[type="range"] { width: 100px; accent-color: #ec4899; }
        .row .val { min-width: 40px; text-align: right; color: #ec4899; font-weight: 600; font-size: 0.85rem; }
        .row-input { display: flex; gap: 10px; margin-bottom: 10px; }
        .row-input input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #334155; border-radius: 8px; background: #0f172a; color: #fff; font-size: 0.9rem; }
        .row-input input[type="text"]:focus { outline: none; border-color: #ec4899; }
        .row-input input[type="text"]::placeholder { color: #64748b; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #0f172a; color: #fff; font-size: 0.9rem; }
        .btn-start { width: 100%; padding: 16px; font-size: 1rem; font-weight: 600; border: none; border-radius: 12px; background: linear-gradient(135deg, #ec4899, #be185d); color: #fff; cursor: pointer; margin-bottom: 10px; }
        .btn-start:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .btn-ia { width: 100%; padding: 14px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: 12px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: #fff; cursor: pointer; margin-bottom: 10px; }
        .btn-ia:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .btn-preview { width: 100%; padding: 10px; border: 1px solid #334155; border-radius: 8px; background: transparent; color: #ec4899; cursor: pointer; font-size: 0.8rem; margin-top: 8px; }
        .btn-preview:disabled { opacity: 0.5; }
        .error { background: #450a0a; border: 1px solid #dc2626; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; }
        .success { background: #052e16; border: 1px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; }
        .voice-info { font-size: 0.85rem; color: #94a3b8; margin-bottom: 8px; }
        .voice-name { color: #ec4899; font-weight: 600; }
        .phrase-box { background: #1e293b; border-radius: 16px; padding: 30px 20px; min-height: 160px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; margin-bottom: 20px; }
        .video-counter { font-size: 0.75rem; color: #ec4899; margin-bottom: 6px; font-weight: 600; }
        .phrase-counter { font-size: 0.8rem; color: #64748b; margin-bottom: 10px; }
        .phrase-text { font-size: 1.3rem; line-height: 1.5; }
        .rep-indicator { font-size: 0.75rem; color: #ec4899; margin-top: 10px; }
        .status-bar { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 0.8rem; color: #64748b; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #334155; }
        .status-dot.speaking { background: #4ade80; animation: pulse 1s infinite; }
        .status-dot.waiting { background: #fbbf24; }
        .status-dot.paused { background: #ec4899; }
        .status-dot.loading { background: #60a5fa; animation: pulse 0.5s infinite; }
        .status-dot.finished { background: #ec4899; }
        .status-dot.generating { background: #8b5cf6; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress { height: 3px; background: #334155; border-radius: 2px; margin-bottom: 24px; overflow: hidden; }
        .progress-fill { height: 100%; background: #ec4899; transition: width 0.3s; }
        .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .btn-ctrl { padding: 16px 8px; border: none; border-radius: 12px; background: #1e293b; color: #fff; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; color: #94a3b8; }
        .btn-ctrl:active { transform: scale(0.95); background: #334155; }
        .btn-ctrl .icon { font-size: 1.3rem; }
        .btn-ctrl.primary { background: linear-gradient(135deg, #ec4899, #be185d); grid-column: span 3; padding: 20px; font-size: 0.9rem; color: #fff; }
        .btn-ctrl.primary .icon { font-size: 1.6rem; }
        .btn-ctrl.next-video { background: linear-gradient(135deg, #22c55e, #16a34a); grid-column: span 3; padding: 24px; font-size: 1rem; color: #fff; }
        .btn-ctrl.next-video .icon { font-size: 1.8rem; }
        .btn-back { width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 10px; background: transparent; color: #64748b; cursor: pointer; font-size: 0.85rem; }
        .video-progress { display: flex; justify-content: center; gap: 6px; margin-bottom: 16px; }
        .video-dot { width: 10px; height: 10px; border-radius: 50%; background: #334155; }
        .video-dot.done { background: #22c55e; }
        .video-dot.current { background: #ec4899; animation: pulse 1s infinite; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        .loading-overlay h2 { margin-bottom: 20px; font-size: 1.2rem; }
        .loading-overlay p { color: #64748b; font-size: 0.9rem; margin-bottom: 10px; }
        .loading-bar { width: 200px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .loading-bar-fill { height: 100%; background: #ec4899; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div id="setup" class="screen active">
            <h1>üéß Teleprompter Auditivo</h1>
            <div id="error" class="error" style="display:none"></div>
            <div id="success" class="success" style="display:none"></div>
            
            <div class="section">
                <div class="section-title">Datos del v√≠deo</div>
                <div class="row-input">
                    <input type="text" id="inmobiliaria" placeholder="Nombre inmobiliaria">
                    <input type="text" id="ciudad" placeholder="Ciudad">
                </div>
            </div>
            
            <textarea id="script" placeholder="Pega tu guion en bruto aqu√≠...

Luego pulsa 'Procesar con IA' para optimizarlo autom√°ticamente."></textarea>
            <div class="hint">üí° Pega el guion de Gemini tal cual. Claude lo optimizar√°: mejora redacci√≥n, corta frases, decide repeticiones.</div>
            
            <button id="btnIA" class="btn-ia" disabled>‚ú® Procesar con IA</button>
            
            <div class="section">
                <div class="voice-info">Voz: <span class="voice-name" id="voiceName">Cargando...</span></div>
                <select id="voiceSelect" style="display:none"></select>
                <button id="btnPreview" class="btn-preview" disabled>üîä Escuchar voz</button>
            </div>
            
            <div class="section">
                <div class="section-title">Configuraci√≥n</div>
                <div class="row"><label>Velocidad</label><input type="range" id="speed" min="0.5" max="1.5" step="0.1" value="1"><span class="val" id="speedVal">1x</span></div>
                <div class="row"><label>Estabilidad</label><input type="range" id="stability" min="0" max="1" step="0.1" value="0.2"><span class="val" id="stabilityVal">0.2</span></div>
                <div class="row"><label>Expresividad</label><input type="range" id="similarity" min="0" max="1" step="0.1" value="0.5"><span class="val" id="similarityVal">0.5</span></div>
            </div>
            
            <div class="section">
                <div class="section-title">Pausas entre frases</div>
                <div class="row"><label>Multiplicador</label><input type="range" id="mult" min="0.5" max="3" step="0.25" value="1"><span class="val" id="multVal">1x</span></div>
            </div>
            
            <button id="btnStart" class="btn-start" disabled>‚ñ∂ Preparar y empezar</button>
        </div>
        
        <div id="player" class="screen">
            <div class="video-progress" id="videoProgress"></div>
            <div class="phrase-box">
                <div class="video-counter" id="videoCounter">V√≠deo 1 de 1</div>
                <div class="phrase-counter" id="counter">1 / 1</div>
                <div class="phrase-text" id="phraseText"></div>
                <div class="rep-indicator" id="repInd"></div>
            </div>
            <div class="status-bar"><div class="status-dot" id="statusDot"></div><span id="statusText">Listo</span></div>
            <div class="progress"><div class="progress-fill" id="progressFill"></div></div>
            
            <div class="controls" id="controlsNormal">
                <button class="btn-ctrl" id="btnPrev"><span class="icon">‚èÆ</span>Anterior</button>
                <button class="btn-ctrl" id="btnRepeat"><span class="icon">‚Üª</span>Repetir</button>
                <button class="btn-ctrl" id="btnNext"><span class="icon">‚è≠</span>Siguiente</button>
                <button class="btn-ctrl primary" id="btnPlayPause"><span class="icon">‚è∏</span><span id="ppText">Pausar</span></button>
            </div>
            
            <div class="controls" id="controlsNextVideo" style="display:none">
                <button class="btn-ctrl next-video" id="btnNextVideo"><span class="icon">‚ñ∂</span><span>Siguiente v√≠deo</span></button>
            </div>
            
            <button class="btn-back" id="btnBack">‚Üê Volver</button>
        </div>
        
        <div id="loadingOverlay" class="loading-overlay" style="display:none">
            <h2 id="loadingTitle">Procesando...</h2>
            <p id="loadingText">Preparando guion...</p>
            <div class="loading-bar"><div class="loading-bar-fill" id="loadingBar"></div></div>
        </div>
    </div>
<script>
const API_ELEVENLABS = 'https://elevenlabs-proxy.ajnietoc.workers.dev';
const API_CLAUDE = 'https://claude-guiones.ajnietoc.workers.dev';

let voices=[],videos=[],phrases=[],phraseReps=[],idx=0,rep=0,videoIdx=0,playing=false,paused=false,audio=null,timeout=null,lastDur=0,cache={};
let cfg={speed:1,stability:0.2,similarity:0.5,mult:1,voiceId:null,voiceName:''};
let guionProcesado=false;

const $=id=>document.getElementById(id);
const showErr=m=>{$('error').textContent=m;$('error').style.display='block';$('success').style.display='none';};
const hideErr=()=>$('error').style.display='none';
const showSuccess=m=>{$('success').textContent=m;$('success').style.display='block';$('error').style.display='none';};

function playBeep(){
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.connect(g);g.connect(ctx.destination);
    o.frequency.value=880;
    o.type='sine';
    g.gain.setValueAtTime(0.3,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5);
    o.start(ctx.currentTime);
    o.stop(ctx.currentTime+0.5);
}

function showLoading(title,text,progress){
    $('loadingOverlay').style.display='flex';
    $('loadingTitle').textContent=title;
    $('loadingText').textContent=text;
    $('loadingBar').style.width=progress+'%';
}
function hideLoading(){$('loadingOverlay').style.display='none';}

async function loadVoices(){
    try{
        const r=await fetch(API_ELEVENLABS+'/voices');
        if(!r.ok)throw new Error();
        const d=await r.json();
        voices=d.voices;
        let stela=voices.find(v=>v.name.toLowerCase().includes('stela'));
        if(stela){selectVoice(stela.voice_id,stela.name);}
        else if(voices.length>0){selectVoice(voices[0].voice_id,voices[0].name);}
        $('voiceSelect').innerHTML=voices.map(v=>'<option value="'+v.voice_id+'"'+(v.voice_id===cfg.voiceId?' selected':'')+'>'+v.name+'</option>').join('');
        $('voiceSelect').style.display='block';
        $('btnPreview').disabled=false;
    }catch(e){$('voiceName').textContent='Error';showErr('No se pudieron cargar las voces');}
}

function selectVoice(id,name){cfg.voiceId=id;cfg.voiceName=name;$('voiceName').textContent=name;checkButtons();}

function checkButtons(){
    $('btnIA').disabled=!$('script').value.trim();
    $('btnStart').disabled=!($('script').value.trim()&&cfg.voiceId&&guionProcesado);
}

async function procesarConIA(){
    var guion=$('script').value.trim();
    if(!guion)return;
    
    showLoading('‚ú® Procesando con IA','Claude est√° optimizando tu guion...',30);
    $('btnIA').disabled=true;
    
    try{
        const r=await fetch(API_CLAUDE,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                guion:guion,
                inmobiliaria:$('inmobiliaria').value.trim(),
                ciudad:$('ciudad').value.trim()
            })
        });
        
        if(!r.ok)throw new Error('Error en la API');
        const d=await r.json();
        if(d.error)throw new Error(d.error);
        
        $('script').value=d.guion;
        guionProcesado=true;
        hideLoading();
        showSuccess('‚úì Guion optimizado. Rev√≠salo y pulsa "Preparar y empezar".');
        checkButtons();
    }catch(e){
        hideLoading();
        showErr('Error procesando: '+e.message);
        $('btnIA').disabled=false;
    }
}

function parseGuionProcesado(text){
    var lines=text.split('\n').map(function(l){return l.trim();}).filter(function(l){return l;});
    var vids=[];
    var currentVideo=[];
    var currentReps=[];
    
    for(var i=0;i<lines.length;i++){
        var line=lines[i];
        
        // Detectar separador de video
        if(line==='---'||line==='***'){
            if(currentVideo.length>0){
                vids.push({phrases:currentVideo,reps:currentReps});
                currentVideo=[];
                currentReps=[];
            }
            continue;
        }
        
        // Parsear [1x] o [2x]
        var match=line.match(/^\[(\d)x\]\s*(.+)$/);
        if(match){
            currentReps.push(parseInt(match[1]));
            currentVideo.push(match[2]);
        }else if(line){
            currentReps.push(1);
            currentVideo.push(line);
        }
    }
    
    if(currentVideo.length>0){
        vids.push({phrases:currentVideo,reps:currentReps});
    }
    
    return vids;
}

async function genSpeech(text){
    const key=cfg.voiceId+'-'+text+'-'+cfg.speed+'-'+cfg.stability+'-'+cfg.similarity;
    if(cache[key])return cache[key];
    const r=await fetch(API_ELEVENLABS+'/text-to-speech/'+cfg.voiceId,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text:text,model_id:'eleven_multilingual_v2',voice_settings:{stability:cfg.stability,similarity_boost:cfg.similarity,speed:cfg.speed}})
    });
    if(!r.ok)throw new Error('Error generando audio');
    const blob=await r.blob();
    cache[key]=URL.createObjectURL(blob);
    return cache[key];
}

async function preGenerarTodo(){
    var allPhrases=[];
    for(var v=0;v<videos.length;v++){
        for(var p=0;p<videos[v].phrases.length;p++){
            allPhrases.push(videos[v].phrases[p]);
        }
    }
    
    for(var i=0;i<allPhrases.length;i++){
        showLoading('üîä Generando audio','Frase '+(i+1)+' de '+allPhrases.length,Math.round((i+1)/allPhrases.length*100));
        await genSpeech(allPhrases[i]);
    }
}

function stopAudio(){if(audio){audio.pause();audio=null;}if(timeout){clearTimeout(timeout);timeout=null;}}

function setStatus(s){
    $('statusDot').className='status-dot '+s;
    $('statusText').textContent=s==='speaking'?'Dictando...':s==='waiting'?'Tu turno':s==='paused'?'Pausa':s==='loading'?'Cargando...':s==='finished'?'¬°V√≠deo terminado!':'Listo';
}

function updateUI(){
    $('videoCounter').textContent='V√≠deo '+(videoIdx+1)+' de '+videos.length;
    $('counter').textContent=(idx+1)+' / '+phrases.length;
    $('phraseText').textContent=phrases[idx]||'';
    $('progressFill').style.width=((idx+1)/phrases.length*100)+'%';
    var maxRep=phraseReps[idx]||1;
    $('repInd').textContent=maxRep>1?'Rep '+(rep+1)+'/'+maxRep:'';
    var dots='';
    for(var i=0;i<videos.length;i++){
        if(i<videoIdx)dots+='<div class="video-dot done"></div>';
        else if(i===videoIdx)dots+='<div class="video-dot current"></div>';
        else dots+='<div class="video-dot"></div>';
    }
    $('videoProgress').innerHTML=dots;
}

function showNextVideoButton(){
    $('controlsNormal').style.display='none';
    $('controlsNextVideo').style.display='grid';
    setStatus('finished');
    playBeep();
}

function hideNextVideoButton(){
    $('controlsNormal').style.display='grid';
    $('controlsNextVideo').style.display='none';
}

async function playPhrase(){
    if(!playing||paused||idx>=phrases.length)return;
    updateUI();setStatus('speaking');
    try{
        const url=await genSpeech(phrases[idx]);
        audio=new Audio(url);
        const start=Date.now();
        audio.onended=function(){
            lastDur=(Date.now()-start)/1000;
            rep++;
            var maxRep=phraseReps[idx]||1;
            if(rep<maxRep){
                updateUI();
                timeout=setTimeout(playPhrase,400);
                return;
            }
            rep=0;
            if(idx<phrases.length-1){
                setStatus('waiting');
                timeout=setTimeout(function(){idx++;playPhrase();},lastDur*cfg.mult*1000);
            }else{
                playing=false;
                if(videoIdx<videos.length-1){
                    showNextVideoButton();
                }else{
                    setStatus('');
                    $('ppText').textContent='Reiniciar';
                    $('btnPlayPause').querySelector('.icon').textContent='‚ñ∂';
                    playBeep();
                }
            }
        };
        audio.play();
    }catch(e){showErr(e.message);playing=false;}
}

function startVideo(vIdx){
    videoIdx=vIdx;
    phrases=videos[videoIdx].phrases;
    phraseReps=videos[videoIdx].reps;
    idx=0;rep=0;
    hideNextVideoButton();
    updateUI();
    playing=true;paused=false;
    $('ppText').textContent='Pausar';
    $('btnPlayPause').querySelector('.icon').textContent='‚è∏';
    playPhrase();
}

$('script').addEventListener('input',function(){guionProcesado=false;checkButtons();});
$('voiceSelect').addEventListener('change',function(e){var v=voices.find(x=>x.voice_id===e.target.value);if(v)selectVoice(v.voice_id,v.name);});
$('speed').addEventListener('input',function(e){cfg.speed=parseFloat(e.target.value);$('speedVal').textContent=cfg.speed+'x';});
$('stability').addEventListener('input',function(e){cfg.stability=parseFloat(e.target.value);$('stabilityVal').textContent=cfg.stability;});
$('similarity').addEventListener('input',function(e){cfg.similarity=parseFloat(e.target.value);$('similarityVal').textContent=cfg.similarity;});
$('mult').addEventListener('input',function(e){cfg.mult=parseFloat(e.target.value);$('multVal').textContent=cfg.mult+'x';});

$('btnIA').addEventListener('click',procesarConIA);

$('btnPreview').addEventListener('click',async function(){
    $('btnPreview').disabled=true;$('btnPreview').textContent='Generando...';
    try{var url=await genSpeech('Hola, esta es una prueba de voz.');var a=new Audio(url);a.onended=function(){$('btnPreview').disabled=false;$('btnPreview').textContent='üîä Escuchar voz';};a.play();}
    catch(e){showErr(e.message);$('btnPreview').disabled=false;$('btnPreview').textContent='üîä Escuchar voz';}
});

$('btnStart').addEventListener('click',async function(){
    videos=parseGuionProcesado($('script').value);
    if(!videos.length||!videos[0].phrases.length){showErr('No hay guiones');return;}
    cache={};hideErr();
    
    // Pre-generar todo
    try{
        await preGenerarTodo();
        hideLoading();
        $('setup').classList.remove('active');
        $('player').classList.add('active');
        startVideo(0);
    }catch(e){
        hideLoading();
        showErr('Error generando audio: '+e.message);
    }
});

$('btnNextVideo').addEventListener('click',function(){
    if(videoIdx<videos.length-1){startVideo(videoIdx+1);}
});

$('btnPlayPause').addEventListener('click',function(){
    if(!playing){startVideo(videoIdx);}
    else if(paused){paused=false;$('ppText').textContent='Pausar';$('btnPlayPause').querySelector('.icon').textContent='‚è∏';playPhrase();}
    else{paused=true;stopAudio();setStatus('paused');$('ppText').textContent='Continuar';$('btnPlayPause').querySelector('.icon').textContent='‚ñ∂';}
});

$('btnPrev').addEventListener('click',function(){stopAudio();idx=Math.max(0,idx-1);rep=0;updateUI();if(playing&&!paused)playPhrase();});
$('btnNext').addEventListener('click',function(){stopAudio();idx=Math.min(phrases.length-1,idx+1);rep=0;updateUI();if(playing&&!paused)playPhrase();});
$('btnRepeat').addEventListener('click',function(){stopAudio();rep=0;if(playing&&!paused)playPhrase();});
$('btnBack').addEventListener('click',function(){stopAudio();playing=false;paused=false;$('player').classList.remove('active');$('setup').classList.add('active');hideNextVideoButton();});

loadVoices();
</script>
</body>
</html>
